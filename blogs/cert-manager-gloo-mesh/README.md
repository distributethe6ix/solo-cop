# Cert Manager + Gloo Mesh

Using this guide we will install and configure cert-manager integration with Gloo Mesh and Istio

## Install cert-manager
```
helm repo add jetstack https://charts.jetstack.io
helm repo update
helm upgrade --install jetstack jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.7.2 --set-string installCRDs=true
```

## Configure cert manager components
Create the gloo mesh namespace
```
kubectl create ns gloo-mesh
```

Apply the the self-signed relay root CA that cert-manager will be using to generate additional certificates from
```
kubectl apply -f cert/gloo-mesh-relay-root-ca.yaml
```

Next we will create an Issuer which will use this CA secret
```
kubectl apply -f cert/gloo-mesh-relay-issuer.yaml
```

Now generate the relay certs used for the control plane / agent registration process
```
kubectl apply -f cert/gloo-mesh-cert.yaml
kubectl apply -f cert/gloo-mesh-agent-cert.yaml
```

Check all certificates
```
% kubectl get Certificates -A
NAMESPACE   NAME                    READY   SECRET                 AGE
gloo-mesh   gloo-mesh-mgmt-server   True    gloo-server-tls-cert   13s
gloo-mesh   gloo-mesh-agent         True    gloo-agent-tls-cert    13s
```

## install gloo-mesh control plane
Set GM_LICENSE_KEY variable
```
GM_LICENSE_KEY="eyJhZGRPbnMiOlt7IkFkZG9uIjowLCJFeHBpcmVzQXQiOjE2ODg0Mjg5MDYsIkxpY2Vuc2VUeXBlIjoiZW50In1dLCJleHAiOjE2ODg0Mjg5MDYsImlhdCI6MTY2MjUwODkwNiwiayI6InJ1ZDExZyIsImx0IjoiZW50IiwicHJvZHVjdCI6Imdsb28tdHJpYWwifQ.by7jozgqnuvVDigCfnO5cZMsY3pklnIpXIt8wDPejgM"
```

Deploy Gloo Mesh Enterprise using Helm
```
helm repo add gloo-mesh-enterprise https://storage.googleapis.com/gloo-mesh-enterprise/gloo-mesh-enterprise
helm repo update
helm upgrade --install gloo-mesh-enterprise gloo-mesh-enterprise/gloo-mesh-enterprise --namespace gloo-mesh --create-namespace --version 2.1.2 --set-string licenseKey=$GM_LICENSE_KEY --values helm/cp-values.yaml
```

## install gloo-mesh-agent
Deploy Gloo Mesh Agent using Helm
```
helm repo add gloo-mesh-agent https://storage.googleapis.com/gloo-mesh-enterprise/gloo-mesh-agent
helm repo update
helm upgrade --install gloo-mesh-agent gloo-mesh-agent/gloo-mesh-agent \
  --version 2.1.2 \
  --namespace gloo-mesh \
  --kube-context=mgmt \
  --values helm/agent-values.yaml
```

Lastly we will apply the `KuberentesCluster` CRD to complete the agent registration process. Note the use of the label `roottrust: shared` as we will use this later to establish shared root trust across multiple clusters
```
kubectl apply --context ${MGMT} -f- <<EOF
apiVersion: admin.gloo.solo.io/v2
kind: KubernetesCluster
metadata:
  name: mgmt
  namespace: gloo-mesh
  labels:
    roottrust: shared
spec:
  clusterDomain: cluster.local
EOF
```

### port-forward to gloo-mesh-ui to check status
```
kubectl port-forward -n gloo-mesh svc/gloo-mesh-ui 8090
```

Access the UI in your browser at http://localhost:8090

You should see that the agent on the `mgmt` cluster has been registered

## Deploy Istio with ILCM
With the control plane and agents deployed and configured, you can use the `IstioLifecycleManager` and `GatewayLifecycleManager` CRDs to have Gloo Mesh manage new deployments of Istio

First deploy control plane
```
kubectl apply -f lifecycle/ilcm-mgmt.yaml
```

Watch the istio-system namespace, this may take a few minutes
```
% kubectl get pods -n istio-system -w
NAME                           READY   STATUS    RESTARTS   AGE
istiod-1-15-6b66f9f4cf-tgcrv   1/1     Running   0          3m46s
```

The `IstioLifecycleManager` uses the Istio Operator under the hood, so you can also check the output of the generated Istio operator logs
```
% kubectl logs -n gm-iop-1-15 istio-operator-1-15-55779dfd6c-tblp2
2022-12-13T22:51:26.509137Z     info    installer       Processing resources from manifest: IngressGateways for CR istiod-control-plane-mgmt-gm-iop-1-15-IngressGateways-https://10.43.0.1:443
2022-12-13T22:51:26.509146Z     info    installer       Generated manifest objects are the same as cached for component IngressGateways.
- Processing resources for Istiod. Waiting for Deployment/istio-system/istiod-1-15
âœ” Istiod installed
```

Next the gateways
```
kubectl apply -f lifecycle/glcm-ns-mgmt.yaml
```

Watch the istio-gateways namespace
```
% k get pods -n istio-gateways -w
NAME                                         READY   STATUS    RESTARTS   AGE
svclb-istio-ingressgateway-bdksh             2/2     Running   0          21m
istio-ingressgateway-1-15-6b756d9594-jwllj   1/1     Running   0          4m36s
```

You can also check the output of the generated Istio operator logs again if you need more detail


### Review default secrets generated by Istio
If you take a look at the secrets generated by Istio by default you will see the default Root CA named `istio-ca-secret`. Note that if you were to deploy Istio on another cluster, these two Root CA secrets would be unique.
```
% kubectl get secrets -n istio-system
NAME                                       TYPE                                  DATA   AGE
default-token-vnjdn                        kubernetes.io/service-account-token   3      2m15s
istio-reader-service-account-token-z9gsd   kubernetes.io/service-account-token   3      115s
istiod-service-account-token-bzhvh         kubernetes.io/service-account-token   3      115s
istiod-1-15-token-78gbd                    kubernetes.io/service-account-token   3      114s
istio-ca-secret                            istio.io/ca-root                      5      107s
```

Using Gloo Mesh and Cert Manager, we can easily unify the Root Trust across many clusters in an automated fashion. This is especially important when clusters in the mesh require cross-cluster communication over mTLS!

## Generate certs to be used for shared root trust
In this example we will use the cert-manager `selfsigned` issuer. In a real-world scenario, you would replace this `selfsigned` issuer with the Issuer provided by your Enterprise PKI
```
kubectl apply -f cert/certmanager-selfsigned-issuer.yaml
```

Then the root CA that we will want Gloo Mesh to manage
```
kubectl apply -f cert/certmanager-istio-ca-cert.yaml
```
If you take a look at the manifest, you can see the use of the `selfsigned` issuer as well as the `isCA: true`. 

This will create a secret named `dummy-signing-secret` in the gloo-mesh namespace
```
% k get secrets -n gloo-mesh | grep signing
dummy-signing-cert                           kubernetes.io/tls                     3      20s
```

You can also check the status of all the Certificates
```
% kubectl get certs -A
NAMESPACE   NAME                    READY   SECRET                 AGE
gloo-mesh   gloo-mesh-mgmt-server   True    gloo-server-tls-cert   22m
gloo-mesh   gloo-mesh-agent         True    gloo-agent-tls-cert    22m
gloo-mesh   istio-ca                True    dummy-signing-cert     92s
```

# Use RootTrustPolicy to establish shared root trust

The RootTrustPolicy provides a mechanism for Gloo Mesh to establish and manage shared root trust across multiple clusters. The RTP will generate intermediate certificates in the trust chain with the above `dummy-signing-cert` as the root.
```
kubectl apply -f cert/roottrustpolicy-secretref.yaml
```

If you take a look at the manifest, you can see the use of the `applyToMeshes` selector to select `KubernetesClusters` with a label `roottrust: shared` as well as the `secretRef` to our `dummy-signing-cert` created by cert-manager
```
apiVersion: admin.gloo.solo.io/v2
kind: RootTrustPolicy
metadata:
  name: root-trust-policy
  namespace: gloo-mesh
spec:
  applyToMeshes:
  - istio:
      clusterSelector:
        roottrust: shared
  config:
    autoRestartPods: true
    mgmtServerCa:
      secretRef:
        name: dummy-signing-cert
        namespace: gloo-mesh
```

Below is an illustration of the RootTrustPolicy process
![Root Trust Policy Process Flow](images/rtp1.png)

watch istio-system namespace for `cacerts` secret:
```
% k get secrets -n istio-system -w         
NAME                                       TYPE                                       DATA   AGE
default-token-vnjdn                        kubernetes.io/service-account-token        3      17m
istio-reader-service-account-token-z9gsd   kubernetes.io/service-account-token        3      17m
istiod-service-account-token-bzhvh         kubernetes.io/service-account-token        3      17m
istiod-1-15-token-78gbd                    kubernetes.io/service-account-token        3      17m
istio-ca-secret                            istio.io/ca-root                           5      17m
cacerts                                    internal.gloo.solo.io/issued_certificate   4      1s
```

# Next Steps
At this point, if you were to follow the steps on a new cluster (i.e. `cluster1`), Gloo Mesh would automatically configure the above `cacerts` secret with the shared root of trust as a new cluster is deployed and onboarded.

